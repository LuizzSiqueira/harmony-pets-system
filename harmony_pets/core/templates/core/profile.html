{% extends 'core/base.html' %}
{% load static %}
{% load formatters %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/profile.css' %}">
{% endblock %}
{% block content %}
<div class="profile-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="profile-card">
                    <div class="profile-header d-flex align-items-center gap-3">
                        <div class="profile-avatar me-3">
                            {% if interessado %}üë®‚Äçüë©‚Äçüëß‚Äçüë¶{% elif local %}üè¢{% else %}üë§{% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <h2 class="mb-0">{{ user.get_full_name|default:user.username }}</h2>
                            <p class="text-muted mb-1">@{{ user.username }}</p>
                            {% if interessado %}
                                <span class="user-type-badge badge-interessado">Interessado em Ado√ß√£o</span>
                            {% elif local %}
                                <span class="user-type-badge badge-local">Local de Ado√ß√£o</span>
                            {% else %}
                                <span class="user-type-badge badge-interessado">Usu√°rio do Sistema</span>
                            {% endif %}
                        </div>
                        <div class="text-end header-actions">
                            <!-- √önico bot√£o de a√ß√£o (menu) -->
                            <details class="actions-menu">
                                <summary class="btn rounded-pill px-4 py-2 actions-summary" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" title="A√ß√µes">
                                    <i class="fas fa-cog me-2"></i>A√ß√µes
                                </summary>
                                <div class="actions-list">
                                    <!-- Comum a todos -->
                                    <a href="{% url 'edit_profile' %}" class="action-item"><i class="fas fa-edit"></i> Editar Perfil</a>
                                    <a href="{% url 'change_password' %}" class="action-item"><i class="fas fa-key"></i> Alterar Senha</a>

                                    <!-- A√ß√µes espec√≠ficas por tipo de perfil -->
                                    {% if interessado %}
                                        <a href="{% url 'minhas_solicitacoes_adocao' %}" class="action-item"><i class="fas fa-list"></i> Minhas Solicita√ß√µes</a>
                                        <a href="{% url 'meus_pets_adotados' %}" class="action-item"><i class="fas fa-paw"></i> Meus Pets Adotados</a>
                                    {% elif local %}
                                        <a href="{% url 'gerenciar_pets' %}" class="action-item"><i class="fas fa-dog"></i> Meus Pets</a>
                                        <a href="{% url 'solicitacoes_adocao' %}" class="action-item"><i class="fas fa-inbox"></i> Solicita√ß√µes Recebidas</a>
                                    {% endif %}

                                    <!-- Comum a todos -->
                                    <a href="{% url 'home' %}" class="action-item"><i class="fas fa-home"></i> Voltar ao In√≠cio</a>
                                </div>
                            </details>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-section">
                                <h4>Informa√ß√µes B√°sicas</h4>
                                <div class="info-item">
                                    <span class="info-label">Nome Completo:</span>
                                    <span class="info-value">
                                        <span id="nome_anon">{{ user.get_full_name|default:"N√£o informado" }}</span>
                                        <span id="nome_real" style="display:none;">{{ user_real.get_full_name|default:"N√£o informado" }}</span>
                                        <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('nome')" title="Mostrar/ocultar"></i>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">E-mail:</span>
                                    <span class="info-value">
                                        <span id="email_anon">{{ user.email|default:"N√£o informado" }}</span>
                                        <span id="email_real" style="display:none;">{{ user_real.email|default:"N√£o informado" }}</span>
                                        <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('email')" title="Mostrar/ocultar"></i>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data de Cadastro:</span>
                                    <span class="info-value">
                                        {% if user.date_joined %}
                                            {{ user.date_joined|date:"d/m/Y H:i" }}
                                        {% else %}
                                            N√£o informado
                                        {% endif %}
                                    </span>
                                </div>
                            </div> <!-- .info-section (left) -->
                        </div> <!-- .col-md-6 (left) -->

                        <!-- Right column: Interessado / Local e Dados T√©cnicos -->
                        <div class="col-md-6">
                            <div class="info-section">
                                <h4>Interessado / Local</h4>
                                {% if interessado %}
                                    <div class="info-item">
                                        <span class="info-label">CPF:</span>
                                        <span class="info-value">
                                            <span id="cpf_anon">{{ interessado_real.cpf|cpf_mask|default:"N√£o informado" }}</span>
                                            <span id="cpf_real" style="display:none;">{{ interessado_real.cpf|cpf_format|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('cpf')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Telefone:</span>
                                        <span class="info-value">
                                            <span id="telefone_anon">{{ interessado.telefone|default:"N√£o informado" }}</span>
                                            <span id="telefone_real" style="display:none;">{{ interessado_real.telefone|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('telefone')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Endere√ßo:</span>
                                        <span class="info-value">
                                            <span id="endereco_anon">{{ interessado.endereco|default:"N√£o informado" }}</span>
                                            <span id="endereco_real" style="display:none;">{{ interessado_real.endereco|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('endereco')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                {% elif local %}
                                    <div class="info-item">
                                        <span class="info-label">CNPJ:</span>
                                        <span class="info-value">
                                            <span id="cnpj_anon">{{ local_real.cnpj|cnpj_mask|default:"N√£o informado" }}</span>
                                            <span id="cnpj_real" style="display:none;">{{ local_real.cnpj|cnpj_format|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('cnpj')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Telefone:</span>
                                        <span class="info-value">
                                            <span id="telefone_anon">{{ local.telefone|default:"N√£o informado" }}</span>
                                            <span id="telefone_real" style="display:none;">{{ local_real.telefone|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('telefone')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Endere√ßo:</span>
                                        <span class="info-value">
                                            <span id="endereco_anon">{{ local.endereco|default:"N√£o informado" }}</span>
                                            <span id="endereco_real" style="display:none;">{{ local_real.endereco|default:"N√£o informado" }}</span>
                                            <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('endereco')" title="Mostrar/ocultar"></i>
                                        </span>
                                    </div>
                                {% else %}
                                    <p class="text-muted">Nenhuma informa√ß√£o adicional.</p>
                                {% endif %}
                            </div>
                            <div class="info-section mt-3">
                                <h4>Dados T√©cnicos</h4>
                                <div class="info-item">
                                    <span class="info-label">√öltimo Login:</span>
                                    <span class="info-value">{{ user.last_login|default:"Nunca" }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">IP:</span>
                                    <span class="info-value">{{ request.META.HTTP_X_FORWARDED_FOR|default:request.META.REMOTE_ADDR|default:"N√£o dispon√≠vel" }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Logs de seguran√ßa:</span>
                                    <span class="info-value">
                                        <span id="logs_anon">{{ logs_anon }}</span>
                                        <span id="logs_real" style="display:none;">{{ logs_real }}</span>
                                        <i class="fas fa-eye ms-2" style="cursor:pointer;" onclick="toggleSensitive('logs')" title="Mostrar/ocultar"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Se√ß√£o de Seguran√ßa -->
                    <div class="security-section mt-4">
                        <h4 class="section-title mb-3">
                            <i class="fas fa-shield-alt text-primary"></i> Configura√ß√µes de Seguran√ßa
                        </h4>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <h5 class="mb-2">
                                                    <i class="fas fa-mobile-alt"></i> Autentica√ß√£o de Dois Fatores
                                                </h5>
                                                <p class="text-muted mb-0">
                                                    {% if user.two_factor_auth and user.two_factor_auth.is_enabled %}
                                                        <span class="badge bg-success">Ativo</span>
                                                        Sua conta est√° protegida com autentica√ß√£o de dois fatores.
                                                    {% else %}
                                                        <span class="badge bg-warning text-dark">Inativo</span>
                                                        Adicione uma camada extra de seguran√ßa √† sua conta.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <div>
                                                {% if user.two_factor_auth and user.two_factor_auth.is_enabled %}
                                                    <a href="{% url 'disable_2fa' %}" class="btn btn-danger rounded-pill px-4">
                                                        <i class="fas fa-times"></i> Desativar 2FA
                                                    </a>
                                                {% else %}
                                                    <a href="{% url 'setup_2fa' %}" class="btn rounded-pill px-4" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600;">
                                                        <i class="fas fa-shield-alt"></i> Ativar 2FA
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if request.user.is_staff %}
                    <!-- Painel Administrativo: acompanhamento r√°pido -->
                    <div class="admin-dashboard mt-4">
                        <h4 class="section-title mb-3">
                            <i class="fas fa-tachometer-alt text-primary"></i> Painel Administrativo
                        </h4>
                        <div class="row g-3">
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small">Usu√°rios</div>
                                                <div class="h4 mb-0">{{ admin_stats.users_total|default:0 }}</div>
                                            </div>
                                            <i class="fas fa-users text-secondary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="text-muted small">Interessados</div>
                                        <div class="h4 mb-0">{{ admin_stats.interessados_total|default:0 }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="text-muted small">Locais de Ado√ß√£o</div>
                                        <div class="h4 mb-0">{{ admin_stats.locais_total|default:0 }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="text-muted small">Pets (disp./adot./res.)</div>
                                        <div class="h6 mb-0">
                                            {{ admin_stats.pets_disponiveis|default:0 }} / {{ admin_stats.pets_adotados|default:0 }} / {{ admin_stats.pets_reservados|default:0 }}
                                        </div>
                                        <small class="text-muted">Total: {{ admin_stats.pets_total|default:0 }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="text-muted small">Solicita√ß√µes (pend./aprov./rej.)</div>
                                        <div class="h6 mb-0">
                                            {{ admin_stats.sol_pendentes|default:0 }} / {{ admin_stats.sol_aprovadas|default:0 }} / {{ admin_stats.sol_rejeitadas|default:0 }}
                                        </div>
                                        <small class="text-muted">Total: {{ admin_stats.sol_total|default:0 }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="text-muted small">2FA Ativo</div>
                                        <div class="h6 mb-0">{{ admin_stats.twofa_ativos|default:0 }} de {{ admin_stats.twofa_total|default:0 }}</div>
                                        <small class="text-muted">Ado√ß√£o: {{ admin_stats.twofa_taxa|default:0 }}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header py-2">
                                        <strong><i class="fas fa-stream"></i> √öltimas A√ß√µes</strong>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush small">
                                            {% for ev in audit_recent %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div class="text-truncate" style="max-width: 75%;">
                                                        <span class="text-muted">[{{ ev.criado_em|date:'d/m H:i' }}]</span>
                                                        {{ ev.metodo }} {{ ev.caminho }} ‚Üí {{ ev.status_code }}
                                                    </div>
                                                    <span class="badge bg-light text-dark">{{ ev.usuario.username|default:'anon' }}</span>
                                                </div>
                                            {% empty %}
                                                <div class="list-group-item">Sem registros ainda.</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="card-footer py-2 text-end">
                                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'admin_logs' %}"><i class="fas fa-file-alt"></i> Ver logs</a>
                                        <a class="btn btn-sm btn-outline-secondary" href="/admin/"><i class="fas fa-tools"></i> Admin</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0">
                                <div class="card h-100 border-warning">
                                    <div class="card-header py-2">
                                        <strong class="text-warning"><i class="fas fa-exclamation-triangle"></i> Erros Recentes (HTTP ‚â• 400)</strong>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush small">
                                            {% for ev in audit_errors_recent %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div class="text-truncate" style="max-width: 75%;">
                                                        <span class="text-muted">[{{ ev.criado_em|date:'d/m H:i' }}]</span>
                                                        {{ ev.metodo }} {{ ev.caminho }} ‚Üí {{ ev.status_code }}
                                                    </div>
                                                    <span class="badge bg-warning text-dark">{{ ev.usuario.username|default:'anon' }}</span>
                                                </div>
                                            {% empty %}
                                                <div class="list-group-item">Sem erros recentes. √ìtimo!</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="card-footer py-2 text-end">
                                        <a class="btn btn-sm btn-outline-warning" href="{% url 'admin_logs' %}"><i class="fas fa-eye"></i> Acompanhar</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Removido menu duplicado de a√ß√µes para manter apenas um bot√£o de a√ß√£o no header -->
                    <div class="info-section mt-4">
                        <h4 class="mb-3"><i class="fas fa-cogs"></i> A√ß√µes da Conta</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-secondary">
                                    <div class="card-body d-flex flex-column justify-content-between">
                                        <div class="mb-3">
                                            <h5 class="card-title mb-1 text-secondary"><i class="fas fa-user-shield"></i> Remo√ß√£o de Conta conforme Termos</h5>
                                            <p class="card-text text-muted mb-2">A remo√ß√£o segue as diretrizes dos <a href="{% url 'termos_uso' %}" target="_blank">Termos de Uso</a> e Pol√≠tica de Privacidade (LGPD). Revise antes de prosseguir.</p>
                                            <div class="alert alert-secondary small" role="alert">
                                                <ul class="mb-0">
                                                    <li>Requer aceita√ß√£o pr√©via dos termos.</li>
                                                    <li>N√£o remove registros t√©cnicos (auditoria de seguran√ßa).</li>
                                                    <li>Irrevers√≠vel ap√≥s confirma√ß√£o.</li>
                                                    <li>Alternativa: mantenha a conta inativa sem exclus√£o.</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="text-center d-flex flex-column gap-2">
                                            <a href="{% url 'termos_uso' %}" target="_blank" class="btn btn-outline-info btn-sm"><i class="fas fa-file-alt"></i> Revisar Termos de Uso</a>
                                            <a href="{% url 'termos_uso' %}#politica-privacidade" target="_blank" class="btn btn-outline-info btn-sm"><i class="fas fa-shield-alt"></i> Revisar Pol√≠tica de Privacidade</a>
                                            <a href="{% url 'contato' %}" class="btn btn-outline-primary btn-sm"><i class="fas fa-question-circle"></i> Suporte</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-body d-flex flex-column justify-content-between">
                                        <div class="mb-3">
                                            <h5 class="card-title mb-1 text-danger"><i class="fas fa-user-times"></i> Excluir minha conta</h5>
                                            <p class="card-text text-muted mb-2">A exclus√£o √© imediata e permanente. Esta a√ß√£o n√£o pode ser desfeita.</p>
                                            <div class="alert alert-danger small" role="alert">
                                                Ao excluir sua conta:
                                                <ul class="mb-0">
                                                    <li>Seu perfil e dados pessoais ser√£o removidos.</li>
                                                    <li>Suas solicita√ß√µes de ado√ß√£o vinculadas ser√£o apagadas.</li>
                                                    <li>Se for um <strong>Local de Ado√ß√£o</strong>, os <strong>pets cadastrados</strong> por este perfil e respectivas solicita√ß√µes tamb√©m ser√£o removidos.</li>
                                                    <li>Registros de auditoria (hist√≥rico t√©cnico) permanecem para seguran√ßa, <em>sem seus dados pessoais</em>.</li>
                                                </ul>
                                            </div>
                                        </div>
                                        {% if account_deletion_enabled %}
                                        <form method="post" action="{% url 'delete_account' %}" onsubmit="return confirm('Tem certeza que deseja excluir sua conta AGORA? Esta a√ß√£o √© irrevers√≠vel e remover√° seus dados imediatamente.')">
                                            {% csrf_token %}
                                            <div class="form-check text-start mb-3">
                                                <input class="form-check-input" type="checkbox" name="confirm_delete" id="confirm_delete">
                                                <label for="confirm_delete" class="form-check-label small">
                                                    Confirmo que li e compreendi as consequ√™ncias e desejo prosseguir com a exclus√£o permanente.
                                                </label>
                                            </div>
                                            <div class="text-center">
                                                <button type="submit" class="btn btn-danger" aria-disabled="false">
                                                    <i class="fas fa-trash-alt"></i> Excluir definitivamente
                                                </button>
                                            </div>
                                        </form>
                                        {% else %}
                                            <div class="alert alert-warning small" role="alert">
                                                A exclus√£o de contas est√° desativada pela pol√≠tica atual da plataforma. Entre em contato com o suporte caso necess√°rio.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
<script>
function toggleSensitive(field) {
    const anon = document.getElementById(field + '_anon');
    const real = document.getElementById(field + '_real');
    if (anon && real) {
        if (anon.style.display === 'none') {
            anon.style.display = 'inline';
            real.style.display = 'none';
        } else {
            anon.style.display = 'none';
            real.style.display = 'inline';
        }
    }
}

</script>
{% endblock %}
